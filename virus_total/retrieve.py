import json
import requests
from config import load_config


def retrieve(id, of=""):
    print '[INFO] Start retrieving scan result'
    retrieve_api = load_config()['RESULT_API']
    api_key = load_config()['APIKEY']
    try:
        response = requests.get(retrieve_api,
                                params={
                                    'apikey': api_key,
                                    'resource': id
                                })
        if response.status_code == 204:
            print '[WARNING] You have exceed the public API request rate to VirusTotal. Please try again' \
                  'in a few minutes.'
            return
        if response.status_code == 403:
            print '[ERROR] Your API key is invalid or you are not allowed to request'
            return
        response = response.json()
        if response['response_code'] == 1:
            if of:
                json.dump(response, open(of, 'w'), indent=4, sort_keys=True)
            print '[INFO] Scanning file result:'
            print json.dumps(response, indent=4, sort_keys=True)
            return response
        elif response['response_code'] == -2:
            print '[INFO] This scan still in queue. Please try again later'
        elif response['response_code'] == 0:
            print '[ERROR] You have requested for result of a non-exist scan. Please try again'
    except Exception, e:
        print '[ERROR] Cannot retrieve this scan\'s result. {}'.format(e)
