import json
import os

import requests

from android_malware_detector.config import load_config


def scan(fp, of=""):
    print '[INFO] Start queuing file to scan'
    scan_api = load_config()["SCAN_API"]
    api_key = load_config()["APIKEY"]
    fn = os.path.basename(fp)
    try:
        file_info = {'file': (fn, open(fp, 'rb'))}
        response = requests.post(scan_api,
                                 files=file_info,
                                 params={'apikey': api_key})
        if response.status_code == 204:
            print '[WARNING] You have exceed the public API request rate to VirusTotal. Please try again' \
                  'in a few minutes.'
            return
        if response.status_code == 403:
            print '[ERROR] Your API key is invalid or you are not allowed to request'
            return
        response = response.json()
        if of:
            json.dump(response, open(of, 'w'), indent=4, sort_keys=True)
        print '[INFO] Queuing result:'
        print json.dumps(response, indent=4, sort_keys=True)
        return response
    except ValueError:
        print '[ERROR] Cannot retrieve api key'
    except Exception, e:
        print '[ERROR] Cannot scan {}. {}'.format(fn, e)
